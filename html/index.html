<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<title>GeoJSON Test</title>
<style type="text/css">
html, body, #map-canvas {
height: 100%;
margin: 0px;
padding: 0px
}
</style>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
<script>
google.maps.event.addDomListener(window, 'load', function() {
    var map = new google.maps.Map(document.getElementById('map-canvas'), {
        center: { lat: 36.3894816, lng: 139.0634281 },
        zoom: 12
    });

    var infowindow = new google.maps.InfoWindow();

    google.maps.event.addListener(map, "click", function(){
        infowindow.close();
    });

    d3.json('../data/stations.geojson', function(data) {
        map.data.addGeoJson(data);
        map.data.setStyle(function(feature) {
            return getStyle(feature);
        });
        map.data.addListener('click', onClickMarker);
        map.data.addListener('dblclick', onDoubleClickMarker);
    });

    var isVisited = function(feature) {
        if (sessionStorage.getItem(feature.getProperty('No'))) {
            return true;
        } else {
            return false;
        }
    };

    var getStyle = function(feature) {
        if (isVisited(feature)) {
            return {icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'};
        } else {
            return {icon: null};
        }
    };

    var invertStyle = function(feature) {
        if (sessionStorage.getItem(feature.getProperty('No'))) {
            sessionStorage.removeItem(feature.getProperty('No'))
        } else {
            sessionStorage.setItem(feature.getProperty('No'), true)
        }
        map.data.overrideStyle(feature, getStyle(feature));
    }

    var invertHistory = function() {
        if (infowindow.getMap()) {
            invertStyle(infowindow.feature);
            infowindow.close();
        }
    }

    var onClickMarker = function(event) {
        infowindow.content.children[0].innerText = event.feature.getProperty("name");
        infowindow.content.children[1].innerText = "(" + event.feature.getProperty("address") + ")";
        if (isVisited(event.feature)) {
            infowindow.content.children[2].children[0].innerText = "未訪問に戻す";
        } else {
            infowindow.content.children[2].children[0].innerText = "訪問済みにする";
        }
        infowindow.setPosition(event.feature.getGeometry().get());
        infowindow.feature = event.feature;
        infowindow.open(map);
    }

    var onDoubleClickMarker = function(event) {
        invertStyle(event.feature);
        infowindow.close();
    }

    // initialize infowindow
    var initialize_infowindow = function() {
        // pre setup DOM and event listener
        var switcher = $('<a />').attr('href', '#')
        switcher.on('click', function() {
            invertStyle(infowindow.feature);
            infowindow.close();
        });

        var root = document.createElement("div");
        $('<div/>').appendTo(root);
        $('<div/>').appendTo(root);
        $('<div/>').append(switcher).appendTo(root);

        infowindow.setContent(root);
        infowindow.setOptions({pixelOffset: new google.maps.Size(0, -30)});
    };
    initialize_infowindow();
});



    </script>
  </head>
  <body id="map-container">
    <div id="map-canvas"></div>
  </body>
</html>
